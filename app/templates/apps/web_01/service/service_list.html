{% extends '/base/base.html' %}

{% block body %}
<div class="row">
    <!-- Khu v·ª±c qu·∫£n l√Ω b√†n -->
    <div class="col-md-3">
        <div class="card border rounded">
            <div class="card-header text-white">
                <h5 class="card-title">S∆° ƒê·ªì B√†n</h5>
            </div>
            <div class="card-body" >
                <div class="row" id="tableLayout">
                    {% for table in table_list %}
                    <div class="col-md-4 mb-3">
                        <div class="table-item text-center rounded shadow-sm 
                                    {% if table.status == 'available' %}table-empty{% else %}table-occupied{% endif %}
                                    {% if request.GET.get('table','')|string == table.id|string %} active{% endif %}"
                             draggable="true"
                             data-table-id="{{ table.id }}">
                              <!-- Icon bi·ªÉu th·ªã tr·∫°ng th√°i b√†n -->
                              <i class="fas fa-chair fa-2x text-secondary"></i> <!-- B√†n c√≥ kh√°ch -->
                            <p class=" mb-0 fw-bold">{{ table.id }}</p>
                 
                            {% if table.status == 'available' %}
                                 <span class="badge badge-xs badge-success">{{ table.get_status_display() }}</span>
                             {%elif table.status == 'occupied' %}
                                 <span class="badge badge-xs badge-primary">{{ table.get_status_display() }}</span>
                             {%else%}
                                 <span class="badge badge-xs badge-secondary">{{ table.get_status_display() }}</span>
                             {%endif%}
                        </div>
                    </div>
                    {%endfor%}
                </div>
            </div>
        </div>
    </div>

    <!-- Khu v·ª±c order -->
    <div class="col-md-6" id='orderLayout' >
        <div class="card rounded border">
        <div class="card-header text-white p-0" style="min-height: 57px;">
            <ul class="nav nav-tabs" id="orderTabs" role="tablist">
            </ul>
        </div>
        <div class='card-body'>
            <div class="tab-content tabcontent-border" id="orderContents">
            </div>
        </div>
    </div>
    </div>

    <!-- Khu v·ª±c menu -->
    <div class="col-md-3">
        <div class="card rounded border">
            <div class="card-header text-white ">
                <h5 class="card-title">Menu</h5>
            </div>
            <div class="card-body  pt-4">
                <div class="input-group d-xl-inline-flex d-none mb-3">
                    <input type="text" class="form-control" placeholder="Search here...">
                    <button class="input-group-text"><i class="flaticon-381-search-2"></i></button>
                </div>
                <div id="productLayout">
                    {% for product in product_list %}
                        <div class="menu-item p-2 border rounded mb-2" draggable="true" data-item-id="{{ product.id }}">
                            <div class="d-flex justify-content-between align-items-center">
                                <div class="d-flex align-items-center">
                                    <img src="{{ product.image }}" alt="{{ product.name }}" class="img-fluid me-2 rounded"
                                        style="width: 50px; height: 50px; object-fit: cover;">
                                    <span>{{ product.name }}</span>
                                </div>
                                <span>{{ product.price }}</span>
                            </div>
                        </div>
                    {% endfor %}
                </div>
            </div>
        </div>
    </div>
</div>


{% with 
    modal_id = 'modelPaymentOrder',
    modal_title='Phi·∫øu thanh to√°n',
    modal_class_size='modal-md',
    modal_body_tmp = '/apps/web_01/service/modal/modal_payment_order.html'
  %}
    {% include '/popup/popup_create.html' %}
  {%endwith%}


{% endblock %}

{% block script %}
<script type="text/javascript">
    $(document).ready(function () {
        function addOrActivateTab(tableId) {
            let tabId = `tab-${tableId}`;
            let contentId = `content-${tableId}`;
        
            // N·∫øu tab ƒë√£ t·ªìn t·∫°i, ch·ªâ c·∫ßn active n√≥
            if ($(`#${tabId}`).length > 0) {
                $(`#${tabId}`).tab('show');
                return;
            }
        
            // üîπ Th√™m tab m·ªõi
            $("#orderTabs").append(`
                <li class="nav-item" role="presentation">
                    <a class="nav-link d-flex align-items-center px-2 py-1 small-tab" id="${tabId}" data-table-id="${tableId}" data-bs-toggle="tab" href="#${contentId}" role="tab">
                        <i class="fas fa-chair me-1"></i> B√†n ${tableId} 
                        <button class="close-tab btn btn-sm text-danger ms-2">&times;</button>
                    </a>
                </li>
            `);
        
            // üîπ Th√™m n·ªôi dung ƒë∆°n h√†ng b·∫±ng Ajax
            $.ajax({
                url: "{{ url('web_01:get_order_by_table') }}",
                type: 'GET',
                data: { table_id: tableId },
                success: function(response) {
                    $("#orderContents").append(`
                        <div class="tab-pane fade" id="${contentId}" role="tabpanel">
                            ${response}
                        </div>
                    `);
                    $(`#${tabId}`).tab('show'); // K√≠ch ho·∫°t tab sau khi th√™m n·ªôi dung
                },
                error: function(xhr, errmsg, err) {
                    $("#orderContents").append(`
                        <div class="tab-pane fade" id="${contentId}" role="tabpanel">
                            <p class="text-muted">B√†n n√†y ch∆∞a c√≥ ƒë∆°n n√†o.</p>
                        </div>
                    `);
                    $(`#${tabId}`).tab('show');
                }
            });
        
            // X·ª≠ l√Ω ƒë√≥ng tab
            $(`#orderTabs`).on("click", `#${tabId} .close-tab`, function (e) {
                e.stopPropagation();
                $(`#${tabId}`).parent().remove(); // X√≥a tab
                $(`#${contentId}`).remove(); // X√≥a n·ªôi dung tab
        
                // N·∫øu c√≤n tab, active tab ƒë·∫ßu ti√™n
                if ($("#orderTabs li").length > 0) {
                    $("#orderTabs li:first-child a").tab("show");
                }
            });
        }
      
        // S·ª± ki·ªán click v√†o b√†n
        $(".table-item").click(function () {
            let tableId = $(this).data("table-id");
            $('.table-item').removeClass('active');
            $(this).addClass('active');
            addOrActivateTab(tableId);
        });
        // S·ª± ki·ªán click v√†o b√†n
        $(document).on("click", ".small-tab", function () {
            let tableId = $(this).data("table-id");

            // B·ªè active c·ªßa t·∫•t c·∫£ b√†n
            $(".table-item").removeClass("active");

            // T√¨m b√†n t∆∞∆°ng ·ª©ng v√† th√™m class "active"
            $(`.table-item[data-table-id='${tableId}']`).addClass("active");
        });




    });
</script>
{% endblock %}