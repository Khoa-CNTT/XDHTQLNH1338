{% import "/apps/web_01/commom/macros.html" as macros %}

<div class="p-3 mb-3 border rounded bg-light">
    <div class="row">
        <div class="col-md-6">
            <p class="mb-1"><strong><i class="fas fa-chair text-secondary"></i> Bàn:</strong> 
                <span id="tableNumber">Bàn {{ table_id }}</span>
            </p>
            <p class="mb-1"><strong><i class="fas fa-user me-1"></i>Khách hàng:</strong> 
                <span id="customerName">{{ customer_name }}</span>
            </p>
        </div>
        <div class="col-md-6 text-end">
            <p class="mb-1">
                <strong>
                    <i class="fas fa-clock me-1"></i>
                    Giờ vào:
                </strong> 
                <span id="entryTime" class="timer">{{ session.started_at.strftime('%d/%m/%Y %H:%M') }}</span>
            </p>
        </div>
    </div>
</div>

{% for order in order_details %}
    <div class="card mb-3 border shadow-sm {% if order.status == 'paid' %}opacity-50{% endif %}">
        <div class="card-header bg-light d-flex justify-content-between align-items-center">
            <div>
                <input class="form-check-input me-2 order-checkbox"
                       type="checkbox"
                       value="{{ order.order_id }}"
                       data-total="{{ order.order_total }}"
                       {% if order.status == 'completed' %}checked disabled{% endif %}>
                <strong>Đơn #{{ loop.index }}</strong>
            </div>
            <div>
                <span class="badge 
                    {% if order.status == 'completed' %}bg-success{% elif order.status == 'pending' %}bg-warning{% else %}bg-secondary{% endif %}">
                    {% if order.status == 'completed' %}Đã thanh toán{% elif order.status == 'pending' %}Chưa thanh toán{% else %}{% endif %}
                    <span class="ms-1 fa fa-check"></span>
                </span>
                <span class="text-muted">Tổng: {{ macros.format_currency(order.order_total) }}</span>
            </div>
        </div>
        <div class="card-body p-2">
            <table class="table table-sm mb-0">
                <thead>
                    <tr>
                        <th>#</th>
                        <th>Món</th>
                        <th>Số lượng</th>
                        <th>Giá</th>
                        <th>Thành tiền</th>
                        <th>Trạng thái</th>
                        <th></th>
                    </tr>
                </thead>
                <tbody>
                    {% for item in order.order_details %}
                    <tr>
                        <td>{{ loop.index }}</td>
                        <td>
                            <img src="{{ item.product_image_url }}" width="35" class="me-2 rounded">
                            {{ item.product_name }}
                        </td>
                        <td>{{ item.quantity }}</td>
                        <td>{{ macros.format_currency(item.price) }}</td>
                        <td>{{ macros.format_currency(item.total) }}</td>
                        <td>
                            {% if item.status == 'pending' %}
                                <span class="badge badge-warning ">Chờ</span>
                            {% elif item.status == 'in_progress' %}
                                <span class="badge badge-info ">Đang làm</span>
                            {% elif item.status == 'completed' %}
                                <span class="badge badge-success ">Hoàn thành</span>
                            {% else %}
                                <span class="badge badge-danger ">Đã hủy</span>
                            {% endif %}
                        </td>
                        <td>
                            <div class="dropdown text-sans-serif">
                                <button class="btn btn-sm btn-light sharp {% if item.status == 'completed' %}disabled{% endif %}"
                                        type="button"
                                        id="dropdown-item-{{ item.item_id }}"
                                        data-bs-toggle="dropdown"
                                        aria-haspopup="true"
                                        aria-expanded="false"
                                        {% if item.status in ['completed','cancelled'] %}disabled{% endif %}>
                                    <svg width="18px" height="18px" viewBox="0 0 24 24">
                                        <g fill="none" fill-rule="evenodd">
                                            <circle fill="#000000" cx="5" cy="12" r="2"></circle>
                                            <circle fill="#000000" cx="12" cy="12" r="2"></circle>
                                            <circle fill="#000000" cx="19" cy="12" r="2"></circle>
                                        </g>
                                    </svg>
                                </button>
                                {% if item.status != 'completed' %}
                                <div class="dropdown-menu dropdown-menu-end border py-0"
                                     aria-labelledby="dropdown-item-{{ item.item_id }}">
                                    <div class="py-2">
                                        <a class="dropdown-item update-status-option" href="#!"
                                           data-order-id="{{ order.order_id }}"
                                           data-item-id="{{ item.item_id }}" data-status="pending">Chờ</a>
                                        <a class="dropdown-item update-status-option" href="#!"
                                           data-order-id="{{ order.order_id }}"
                                           data-item-id="{{ item.item_id }}" data-status="in_progress">Đang làm</a>
                                        <a class="dropdown-item update-status-option" href="#!"
                                           data-order-id="{{ order.order_id }}"
                                           data-item-id="{{ item.item_id }}" data-status="completed">Hoàn thành</a>
                                        <a class="dropdown-item update-status-option" href="#!"
                                           data-order-id="{{ order.order_id }}"
                                           data-item-id="{{ item.item_id }}" data-status="cancelled">Hủy</a>
                                        <div class="dropdown-divider"></div>
                                        <a class="dropdown-item text-danger" href="#!"
                                           onclick="deleteItem({{ item.item_id }})">Xoá</a>
                                    </div>
                                </div>
                                {% endif %}
                            </div>
                            
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
{% endfor %}

<div class="text-end mb-3">
    <button class="btn btn-primary me-2" onclick="confirm_payment()">
        <i class="fas fa-money-bill-wave"></i> Thanh toán các đơn đã chọn
    </button>
    <span class='h-100 d-inline-block' data-toggle="tooltip" data-placement="top" title="Cần thanh toán trước khi đóng phiên bàn.">
        <button type="button"
                class="btn btn-secondary"
                {% if not all_paid %}disabled{% endif %}>
            <i class="fas fa-sign-out-alt"></i> Kết thúc phiên
        </button>
    </span>
    <div class="mt-2 text-muted">
        Tổng tiền đã chọn: <strong id="finalSelectedTotal">0đ</strong>
    </div>
</div>

{% with 
    modal_id = 'modalPreviewPayment',
    modal_title='Phiếu thanh toán',
    modal_class_size='modal-md'
  %}
    {% include '/popup/popup_preview.html' %}
{%endwith%}

{% block script %}
<script type="text/javascript">

    function updateSelectedOrdersTotal() {
        let total = 0;
        $(".order-checkbox:checked").each(function () {
            total += parseFloat($(this).data("total"));
        });
        $("#finalSelectedTotal").text(total.toLocaleString() + "đ");
    }

    function end_session(session_id) {
        if (!confirm("Bạn có chắc chắn muốn kết thúc phiên này?")) return;
    
        $.ajax({
            url: "{{ url('web_01:end_session') }}",
            type: "POST",
            headers: { 'X-CSRFToken': '{{ csrf_token }}' },
            contentType: "application/json",
            data: JSON.stringify({ session_id: session_id }),
            success: function (res) {
                location.reload()
            },
            error: function (err) {
                console.error(err);
            }
        });
    }

    function confirm_payment() {
        const selectedOrders = $(".order-checkbox:checked").map(function () {
            return $(this).val();
        }).get();

        if (selectedOrders.length === 0) {
            alert("Vui lòng chọn ít nhất một đơn hàng để thanh toán!");
            return;
        }

        $('#modalPreviewPayment').modal('show');
    
        let tableNumber = $('#tableNumber').text();
        let entryTime = $('#entryTime').text();
        let customerName = $('#customerName').text();

        let totalAmount = 0;
        $(".order-checkbox:checked").each(function () {
            totalAmount += parseFloat($(this).data("total"));
        });

        let discountPercent = parseInt($('#discountInput').val()) || 0;
        let discountAmount = Math.round((totalAmount * discountPercent) / 100);
        let amountDue = totalAmount - discountAmount;

        let paymentMethod = $(".payment-methods .btn.active").html();
    
        let html_preview = `
            <div class="preview-payment">
                <p><strong>Bàn:</strong> ${tableNumber}</p>
                <p><strong>Ngày & Giờ vào:</strong> ${entryTime}</p>
                <p><strong>Khách hàng:</strong> ${customerName}</p>
                <hr/>
                <p><strong>Tạm tính:</strong> ${totalAmount.toLocaleString()}đ</p>
                <p><strong>Tiền giảm (${discountPercent}%):</strong> ${discountAmount.toLocaleString()}đ</p>
                <p><strong>Tổng tiền phải trả:</strong> <span id="finalTotal">${amountDue.toLocaleString()}đ</span></p>
                <p><strong>Phương thức thanh toán:</strong> ${paymentMethod}</p>
                <hr/>
                <div class="text-end">
                    <button id="confirmPayment" class="btn btn-success">
                        <i class="fas fa-check-circle"></i> Xác nhận thanh toán
                    </button>
                </div>
            </div>
        `;
    
        $('#modalPreviewPayment #modalBody').html(html_preview);
    }

    $(document).ready(function() {
        $('[data-toggle="tooltip"]').tooltip();
        $(document).on('change', '.order-checkbox', function () {
            updateSelectedOrdersTotal();
        });

        $(".payment-methods .btn").click(function () {
            $(".payment-methods .btn").removeClass("active");
            $(this).addClass("active");
        });

        function updateDiscount(percent) {
            let total = 0;
            $(".order-checkbox:checked").each(function () {
                total += parseFloat($(this).data("total"));
            });
            const discountAmount = Math.round((total * percent) / 100);
            $("#finalTotal").text((total - discountAmount).toLocaleString() + 'đ');
        }

        $("#discountInput").on('input', function() {
            let percent = parseInt($(this).val()) || 0;
            if (percent < 0) percent = 0;
            if (percent > 100) percent = 100;
            $(this).val(percent);
            updateDiscount(percent);
        });

        window.setDiscount = function(percent) {
            $("#discountInput").val(percent);
            updateDiscount(percent);
        };

        $('#modalPreviewPayment').on('click','#confirmPayment',function() {
            const discountPercent = parseInt($("#discountInput").val()) || 0;
            const selectedOrders = $(".order-checkbox:checked").map(function () {
                return $(this).val();
            }).get();

            let total = 0;
            $(".order-checkbox:checked").each(function () {
                total += parseFloat($(this).data("total"));
            });

            const finalTotalText = $("#finalTotal").text().replace(/[^\d]/g, '');
            const finalTotal = parseFloat(finalTotalText) || 0;
            const payment_method = $(".payment-methods .btn.active").data('value');

            const orderData = {
                table_id: {{ table_id }},
                order_ids: selectedOrders,
                discount_percent: discountPercent,
                discount_amount: total - finalTotal,
                total: finalTotal,
                payment_method: payment_method
            };

            $.ajax({
                url: "{{ url('web_01:complete_payment_multi_order') }}",
                type: "POST",
                contentType: "application/json",
                headers: { 'X-CSRFToken': '{{ csrf_token }}' },
                data: JSON.stringify(orderData),
                success: function (response) {
                    location.reload();
                },
                error: function (error) {
                    console.error("Lỗi khi xác nhận thanh toán:", error);
                    alert("Đã xảy ra lỗi khi thanh toán. Vui lòng thử lại.");
                }
            });
        });


        $(document).on('click', '.update-status-option', function () {
            const orderId = $(this).data('order-id');
            const itemId = $(this).data('item-id');
            const status = $(this).data('status');
    
            $.ajax({
                url: "{{ url('web_01:update_item_status') }}",
                method: "POST",
                headers: { "X-CSRFToken": "{{ csrf_token }}" },
                contentType: "application/json",
                data: JSON.stringify({
                    order_id: orderId,
                    item_id: itemId,
                    status: status
                }),
                success: function (res) {
                    location.reload(); // hoặc bạn có thể cập nhật DOM động nếu muốn
                },
                error: function (err) {
                    alert("Cập nhật trạng thái thất bại!");
                    console.error(err);
                }
            });
        });

    });
</script>
{% endblock %}
