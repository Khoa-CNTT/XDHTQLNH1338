
<div id="chatbot-icon" style="position: fixed; bottom: 20px; right: 20px; z-index: 9999; cursor: pointer;">
    <div style="
        background-color: #0dcaf0;  /* Bootstrap info */
        padding: 10px;
        border-radius: 50%;
        box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        display: flex;
        justify-content: center;
        align-items: center;
    ">
        <i class="fas fa-robot text-white" style="font-size: 30px;"></i>
    </div>

    <!-- Chat bubble gợi chuyện -->
    <div id="chatbot-bubble" style="
        display: none;
        position: absolute;
        bottom: 60px;
        right: 0;
        background: #fff;
        border: 1px solid #ddd;
        border-radius: 10px;
        padding: 8px 12px;
        box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        white-space: nowrap;
        font-size: 14px;
        animation: fadeInUp 0.5s ease;
    ">
        Tôi là chatbot, bạn có gì hỏi không?
    </div>
</div>

<div id="chatbot-container" style="display: none; position: fixed; bottom: 90px; right: 20px;width:500px;z-index: 9999;">
    <div class="card mb-0" id="chat2">
        <div class="card-header d-flex justify-content-between align-items-center p-3">
            
            <h5 class="mb-0"><i class="fas fa-robot me-2"></i> Chatbot</h5>
         
                            <!-- Button to toggle fullscreen -->
                            <button id="fullscreen-btn" type="button" class="btn btn-xs" style="background-color: transparent; border: none;">
                                <i class="fas fa-expand"></i>
                            </button>
        </div>
        <div class="card-body" >
            <div class="content mt-3"></div>
            <div class="suggestions mt-3"></div>
        </div>
        

        <div class="card-footer text-muted d-flex justify-content-start align-items-center p-3">
            <img src="https://mdbcdn.b-cdn.net/img/Photos/new-templates/bootstrap-chat/ava3-bg.webp" alt="avatar 3" style="width: 40px;">
            <input type="text" class="form-control form-control-md" id="exampleFormControlInput1" placeholder="Type message">
            <button class="btn btn-info btm-xs ms-3" id="send-btn"><i class="fas fa-paper-plane"></i></button>
        </div>
    </div>
</div>



{%block script%}
<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
<script type="text/javascript">
    const $chatContainer = $('#chatbot-container');
    const $chatBody = $('#chatbot-container .card-body .content');
    const $chatInput = $('#exampleFormControlInput1');
    const $sendBtn = $('#send-btn');
    const $chatBubble = $("#chatbot-bubble");

    // Toggle chatbot container khi nhấn vào icon
    $("#chatbot-icon").on("click", function() {
        $chatContainer.toggle();
        
        if ($chatContainer.is(":visible")) {
            getChatHistory();
            showSuggestedPrompts();
            setTimeout(function() {
                scrollToBottom();  // Scroll after the render cycle
            }, 100);
           
        }
    });

    // Toggle chế độ fullscreen
    $("#fullscreen-btn").on("click", function() {
        $chatContainer.toggleClass("fullscreen");
        const icon = $chatContainer.hasClass("fullscreen") ? "fa-compress" : "fa-expand";
        $(this).html(`<i class="fas ${icon}"></i>`);
    });

    // Hiển thị gợi ý prompt cho người dùng
    function showSuggestedPrompts() {
        const prompts = [
            "Doanh thu hôm nay thế nào?",
            "Tồn kho nguyên liệu như thế nào?",
            "Món ăn nào bán chạy nhất hôm nay?",
            "Lịch sử đơn hàng hôm nay là gì?",
            "Cảnh báo tồn kho thấp?"
        ];
        
        const promptHtml = prompts.map(prompt => `
            <button class="btn btn-outline-secondary btn-sm mb-2 prompt-btn">${prompt}</button>
        `).join('');

        $('#chatbot-container .suggestions').html(promptHtml);

        // Xử lý sự kiện click vào các nút gợi ý
        $(".prompt-btn").on("click", function() {
            sendMessageToBot($(this).text());  // Gửi câu hỏi người dùng đến chatbot
        });
    }

    // Lấy lịch sử trò chuyện từ server
    function getChatHistory() {
        $.get('/get-chat-history/', function(response) {
            disable_element($chatBody);
            
            const chatHistory = response.chat_history;
            const chatContent = chatHistory.map(chat => {
                const userMessage = chat.user_message;
                const botReply = chat.bot_reply;
                return `
                    <div class="d-flex flex-row justify-content-end mb-4">
                        <div>
                            <p class="small p-2 me-3 mb-1 text-white rounded-3 bg-primary">${userMessage}</p>
                            <p class="small me-3 mb-3 rounded-3 text-muted d-flex justify-content-end">${getCurrentTime()}</p>
                        </div>
                        <img src="https://mdbcdn.b-cdn.net/img/Photos/new-templates/bootstrap-chat/ava3-bg.webp" alt="avatar 1" style="width: 45px; height: 100%;">
                    </div>
                    <div class="d-flex flex-row justify-content-start mb-4">
                        <i class="fas fa-robot text-primary me-3" style="font-size: 30px;"></i>
                        <div>
                            ${marked.parse(botReply)}
                            <p class="small mb-3 rounded-3 text-muted">${getCurrentTime()}</p>
                        </div>
                    </div>
                `;
            }).join('');

            $chatBody.html(chatContent);
            scrollToBottom();
            enable_element($chatBody);
        });
    }

    // Hiển thị hộp chat với thông điệp mặc định
    const messages = [
        "Tôi là chatbot, bạn có gì hỏi không?",
        "Bạn cần xem thống kê hôm nay chứ?",
        "Cần gợi ý món bán chạy không?",
        "Tôi có thể giúp bạn đặt bàn hoặc kiểm tra tồn kho!",
        "Hỏi tôi bất kỳ điều gì nhé!"
    ];
    let currentIndex = 0;
    setInterval(() => {
        currentIndex = (currentIndex + 1) % messages.length;
        $chatBubble.fadeOut(300, function() {
            $chatBubble.text(messages[currentIndex]).fadeIn(300);
        });
    }, 4000);

    // Xử lý sự kiện khi nhấn Enter để gửi tin nhắn
    $chatInput.keypress(function(e) {
        if (e.which === 13) { // Mã phím Enter
            $sendBtn.click();
        }
    });

    // Hàm gửi tin nhắn đến chatbot
    function sendMessageToBot(userMessage) {
        // Hiển thị message người dùng
        const userHtml = `
            <div class="d-flex flex-row justify-content-end mb-4">
                <div>
                    <p class="small p-2 me-3 mb-1 text-white rounded-3 bg-primary">${userMessage}</p>
                    <p class="small me-3 mb-3 rounded-3 text-muted d-flex justify-content-end">${getCurrentTime()}</p>
                </div>
                <img src="https://mdbcdn.b-cdn.net/img/Photos/new-templates/bootstrap-chat/ava3-bg.webp" alt="avatar 1" style="width: 45px; height: 100%;">
            </div>
        `;
        $chatBody.append(userHtml);
        $chatInput.val(""); // Xóa nội dung input

        // Thêm biểu tượng "Đang xử lý..."
        const loadingHtml = `
            <div class="d-flex flex-row justify-content-start mb-4" id="loading-message">
                <i class="fas fa-robot text-primary me-3" style="font-size: 30px;"></i>
                <div>
                    <p class="small mb-3 rounded-3 text-muted">Đang xử lý...</p>
                </div>
            </div>
        `;
        $chatBody.append(loadingHtml);
        scrollToBottom();  // Cuộn xuống dưới cùng khi tin nhắn được gửi

        // Gửi tới backend Django
        $.post('/chatbot/', { message: userMessage, csrfmiddlewaretoken: '{{ csrf_token }}' }, function(response) {
            // Loại bỏ biểu tượng "Đang xử lý..."
            $('#loading-message').remove();

            const botReply = marked.parse(response.reply);
            const botHtml = `
                <div class="d-flex flex-row justify-content-start mb-4">
                    <i class="fas fa-robot text-primary" style="font-size: 30px;"></i>
                    <div>
                        ${botReply}
                        <p class="small mb-3 rounded-3 text-muted">${getCurrentTime()}</p>
                    </div>
                </div>
            `;
            $chatBody.append(botHtml);
            showSuggestedPrompts();
            scrollToBottom();  // Đảm bảo cuộn xuống cuối sau khi nhận câu trả lời
        });
    }

    // Xử lý nút gửi tin nhắn
    $sendBtn.click(function () {
        const userMessage = $chatInput.val().trim();
        if (userMessage === "") return;
        sendMessageToBot(userMessage);
    });

    // Lấy thời gian hiện tại
    function getCurrentTime() {
        const now = new Date();
        return now.getHours().toString().padStart(2, '0') + ":" + now.getMinutes().toString().padStart(2, '0');
    }

    // Cuộn xuống dưới cùng cửa sổ chat
    function scrollToBottom() {
        requestAnimationFrame(function() {
            $chatBody.scrollTop($chatBody[0].scrollHeight);
        });
    }
</script>


{%endblock%}