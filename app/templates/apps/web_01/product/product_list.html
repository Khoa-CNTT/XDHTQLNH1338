{% extends '/base/base.html'%}
{%block body%}
<div class="col-lg-12">


    <div class="card">
        <div class="card-body">
            <div class='d-flex' style='gap:8px;'>
                <div class='d-flex flex-column'>
                    <label><strong>Danh m·ª•c</strong></label>
                    <select class="multi-select" style="width:100%;" name="category[]" multiple="multiple" class="form-control form-control-sm bg-white" id="select-category">
                        {% set selected_categories = request.GET.get("category", "").split(",") | map("int") | list %}
                        {% for id, name in category_list %}
                            <option value="{{ id }}" {% if id in selected_categories %}selected{% endif %}>{{ name }}</option>
                        {% endfor %}
                    </select>
                    
                </div>

                <div class='d-flex flex-column'>
                    <label><strong>Gi√°</strong></label>
                    <select  class="form-control form-control-sm" id="select-price">
                        <option value="-1">-- Gi√° --</option>
                        {% set selected_price = request.GET.get("price", "-1") %}
                        {% for id, name in price_list %}
                            <option value="{{ id }}" {% if id == selected_price %}selected{% endif %}>{{ name }}</option>
                        {% endfor %}
                    </select>
                </div>
            </div>
        </div>
        <div class="card-footer">
            <button type="button" class="btn btn-info btn-sm" id="btn-filter">
                <i class="fa fa-filter"></i> L·ªçc
            </button>
            <button type="button" class="btn btn-secondary btn-sm" id="btn-reset">
                <i class="fa fa-times"></i> X√≥a l·ªçc
            </button>
        </div>
        
    </div>

    <!-- Card table list-->
    <div id='data-table-list'>
        <div class="card">
            <div class="card-header">
                <div class='d-flex justify-content-between align-items-center w-100'>
                    <h4 class="card-title">Qu·∫£n l√≠ s·∫£n ph·∫©m</h4>
                    <div>
                        <button type="button" class="btn btn-success btn-sm" data-bs-toggle="modal" data-bs-target="#modalImportProduct">
                            üì• Nh·∫≠p t·ª´ Excel
                        </button>
                        <button type="button" class="btn btn-primary btn-sm" data-bs-toggle="modal" data-bs-target="#modalAddProduct">
                            + Th√™m
                        </button>
                    </div>
                    
                </div>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-responsive-md" id='table_data'>
                        <thead>
                            <tr>
                                <th>#</th>
                                <th>T√™n s·∫£n ph·∫©m</th>
                                <th>H√¨nh ·∫£nh</th>
                                <th>Danh m·ª•c</th>
                                <th>Gi√°</th>
                                <th>Thao t√°c</th>
                            </tr>
                        </thead>
                        <tbody>
                        </tbody>
                    </table>
                    
                    
                </div>
            </div>
        </div>
    </div>
    
</div>



{% with 
    modal_id = 'modalAddProduct',
    modal_title='Th√™m s·∫£n ph·∫©m',
    modal_class_size='modal-lg',
    modal_body_tmp = '/apps/web_01/modal/modal_add_product.html'
  %}
    {% include '/popup/popup_create.html' %}
  {%endwith%}

  {% with 
    modal_id = 'modalImportProduct',
    modal_title='Th√™m s·∫£n ph·∫©m t·ª´ excel',
    modal_class_size='modal-lg',
    modal_body_tmp = '/apps/web_01/modal/modal_import_product.html'
  %}
    {% include '/popup/popup_create.html' %}
  {%endwith%}

{% with 
    modal_id = 'modalDetailProduct',
    modal_title='Chi ti·∫øt s·∫£n ph·∫©m',
    modal_class_size='modal-lg',
    modal_body_tmp = '/apps/web_01/modal/modal_detail_product.html'
  %}
    {% include '/popup/popup_create.html' %}
  {%endwith%}

{%endblock%}

{% block script %}
<script type="text/javascript">

    function updateUrlParams() {
        let selectedCategories = $('#select-category').val() || [];
        let selectedPrice = $('#select-price').val() || "-1"; // Gi√° tr·ªã m·∫∑c ƒë·ªãnh
    
        let params = new URLSearchParams(window.location.search);
    
        if (selectedCategories.length) {
            params.set("category", selectedCategories.join(","));
        } else {
            params.delete("category");
        }
    
        if (selectedPrice !== "-1") {
            params.set("price", selectedPrice);
        } else {
            params.delete("price");
        }
    
        let newUrl = window.location.pathname + "?" + params.toString();
        window.history.replaceState(null, "", newUrl); // C·∫≠p nh·∫≠t URL nh∆∞ng kh√¥ng reload
    }

    
    $(document).ready(function () {
        var table = $('#table_data').DataTable({
            ...DATATABLE_CONFIG,
            processing: true,
            serverSide: true,
            autoWidth: false,  // Ch·∫∑n DataTables t·ª± ƒë·ªông ƒë·∫∑t width c·ªë ƒë·ªãnh
            responsive: true,
            ajax: {
                url: "{{url('web_01:product_list')}}",
                type: "POST",
                headers: { 'X-CSRFToken': '{{ csrf_token }}' },
                data: function (d) {
                    let selectedCategories = $('#select-category').val() || [];
                    d.category = JSON.stringify(selectedCategories); // Chuy·ªÉn danh m·ª•c th√†nh JSON

                    let selectedPrice = $('#select-price').val();
                    d.price = selectedPrice; // G·ª≠i gi√° tr·ªã b·ªô l·ªçc gi√°
                },
                beforeSend: function () {
                    disable_element($('#table_data'));
                },
                complete: function () {
                    enable_element($('#table_data'));
                }
            },
            columns: [
                { data: "index", title: "#" },
                { data: "name", title: "T√™n s·∫£n ph·∫©m" },
                {
                    data: "image",
                    title: "H√¨nh ·∫£nh",
                    render: function(data) {
                        return data 
                            ? `<img src="${data}" alt="H√¨nh ·∫£nh s·∫£n ph·∫©m" class="product-image" style="width: 50px; height: 50px; object-fit: cover; border-radius: 5px;" />`
                            : '<span class="text-muted">Ch∆∞a c√≥ ·∫£nh</span>';
                    }
                },
                { data: "category", title: "Danh m·ª•c" },
                { data: "price", title: "Gi√°" },
                {
                    data: "id",
                    title: "",
                    render: function(data, type, row) {
                        return `
                        <button type='button' class="btn light btn-primary shadow btn-xs sharp me-1" 
                        data-id="${row.id}" 
                        data-name="${row.name}" 
                        data-bs-toggle="modal" data-bs-target="#modalDetailProduct"
                        >
                            <i class="fa fa-eye"></i> <!-- Xem chi ti·∫øt -->
                        </button>
                        `;
                    }
                }
            ],
            columnDefs: [
                { orderable: false, targets: [2,5] },
      
            ]
        });

        // Khi nh·∫•n n√∫t "L·ªçc"
        $('#btn-filter').on('click', function () {
            updateUrlParams();
            table.ajax.reload(); // Load l·∫°i d·ªØ li·ªáu theo b·ªô l·ªçc
        });

        $('#btn-reset').on('click', function () {
            $('#select-category').val(null).trigger('change'); // X√≥a ch·ªçn
            $('#select-price').val('-1').trigger('change'); // X√≥a ch·ªçn
            updateUrlParams();
            table.ajax.reload(); // Load l·∫°i d·ªØ li·ªáu
        });
    })
  

    $('#select-category').select2({
        placeholder: '-- Danh m·ª•c --',
        allowClear: false,
        width: '200',
    });
    $('#select-price').select2({
        placeholder: '-- Gi√° --',
        allowClear: false,
        width: '220',
    });

</script>
{% endblock %}