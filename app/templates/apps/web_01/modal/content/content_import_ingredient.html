<form id="importForm" method="post">
    <input type="hidden" name="csrfmiddlewaretoken" value="{{ csrf_token }}"/> 

    <!-- Khối nguyên liệu -->
    <div class="card border border-secondary shadow-sm" id="ingredients-card">
        <div class="card-body">
            <div id="ingredient-list">
                <!-- Khối nguyên liệu đầu tiên -->
                <div class="row ingredient-item align-items-center mb-2">
                    <div class="col-md-5">
                        <label class="form-label">Nguyên liệu</label>
                        <select name="ingredient[]" class="ingredient-select form-control form-control-sm" required>
                            <option value="">Chọn nguyên liệu...</option>
                            {% for ingredient in ingredients %}
                                <option value="{{ ingredient.id }}">{{ ingredient.name }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="col-md-3">
                        <label class="form-label">Số lượng</label>
                        <input type="number" name="change[]" class="form-control form-control-sm text-center" min="1" value="1" required>
                    </div>
                    <div class="col-md-3">
                        <label class="form-label">Ghi chú</label>
                        <input type="text" name="note[]" class="form-control form-control-sm" placeholder="Ghi chú...">
                    </div>
                    <div class="col-md-1 text-end mt-4">
                        <button type="button" class="remove-ingredient btn btn-danger btn-sm">
                            <i class="fas fa-trash-alt"></i>
                        </button>
                    </div>
                </div>
            </div>

            <!-- Nút thêm nguyên liệu -->
            <button type="button" id="add-ingredient" class="btn btn-primary btn-sm mt-2">
                <i class="fas fa-plus"></i> Thêm nguyên liệu
            </button>
        </div>
    </div>

    <!-- Nút submit -->
    <div class="mt-3 text-end">
        <button type="submit" class="btn btn-success">Xác nhận nhập kho</button>
    </div>
</form>


{% block script %}
<script>
    $(document).ready(function () {
        // Thêm dòng nguyên liệu mới
        $("#add-ingredient").click(function () {
            addIngredient();
            updateDisabledIngredients();
        });

        // Xoá dòng nguyên liệu
        $(document).on("click", ".remove-ingredient", function () {
            $(this).closest(".ingredient-item").remove();
            updateDisabledIngredients();
            validateIngredients();
        });

        // Khi thay đổi nguyên liệu => disable option đã chọn
        $(document).on("change", ".ingredient-select", function () {
            updateDisabledIngredients();
        });

        // Hàm thêm nguyên liệu
        function addIngredient() {
            let newIngredient = `
                <div class="row ingredient-item align-items-center mb-2">
                    <div class="col-md-5">
                        <select name="ingredient[]" class="ingredient-select form-control form-control-sm">
                            <option value="">Chọn nguyên liệu...</option>
                            {% for ingredient in ingredients %}
                                <option value="{{ ingredient.id }}">{{ ingredient.name }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="col-md-3">
                        <input type="number" name="change[]" class="form-control form-control-sm text-center" min="1" value="1">
                    </div>
                    <div class="col-md-3">
                        <input type="text" name="note[]" class="form-control form-control-sm" placeholder="Ghi chú...">
                    </div>
                    <div class="col-md-1 text-end">
                        <button type="button" class="remove-ingredient btn btn-danger btn-sm">
                            <i class="fas fa-trash-alt"></i>
                        </button>
                    </div>
                </div>
            `;
            $("#ingredient-list").append(newIngredient);

            validateIngredients();
        }

        // Không cho trùng nguyên liệu
        function updateDisabledIngredients() {
            let selected = [];
            $(".ingredient-select").each(function () {
                let val = $(this).val();
                if (val) selected.push(val);
            });

            $(".ingredient-select").each(function () {
                let current = $(this).val();
                $(this).find("option").prop("disabled", false);
                selected.forEach(id => {
                    if (id !== current) {
                        $(this).find("option[value='" + id + "']").prop("disabled", true);
                    }
                });
            });
        }

        // Chỉ hiển thị nút xóa khi có nhiều hơn 1 dòng
        function validateIngredients() {
            $(".remove-ingredient").toggle($(".ingredient-item").length > 1);
        }

        validateIngredients();

        // Validate + Submit form qua AJAX
        $('#importForm').bootstrapValidator({
            fields: {
                "ingredient[]": {
                    validators: {
                        notEmpty: { message: 'Vui lòng chọn nguyên liệu!' }
                    }
                },
                "change[]": {
                    validators: {
                        notEmpty: { message: 'Nhập số lượng!' },
                        greaterThan: {
                            value: 0,
                            message: 'Số lượng phải > 0'
                        }
                    }
                }
            }
        }).on('success.form.bv', function (e) {
            e.preventDefault();
            let $form = $(e.target);
            disable_element($('#importForm'));
            $.ajax({
                url: "{{ url('web_01:import_ingredient') }}",
                method: "POST",
                data: $form.serialize(),
                success: function (res) {
                    show_msg_success('#message', 'Nhập nguyên liệu thành công!');
                    $('#importForm')[0].reset();
                    $('.ingredient-item:gt(0)').remove(); // xóa các dòng trừ dòng đầu
                    updateDisabledIngredients();
                    validateIngredients();
                    is_reloading = true;
                    enable_element($('#importForm'));
                },
                error: function (xhr) {
                    let res = xhr.responseJSON;
                    show_msg_error('#message', res?.error || 'Lỗi hệ thống!');
                }
            });
        });
    });
</script>
{% endblock %}

